<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è</title>
    <link rel="stylesheet" href="https://unpkg.com/vkui-tokens@2.0.0/themes/vkBase/cssVars/auto.css">
    <style>
        :root {
            --background-gradient: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            --button-primary: #4CAF50;
            --button-hover: #45a049;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        .vk-app {
            padding: 16px;
            min-height: 100vh;
            background: #f5f5f5;
        }
        
        .app-header {
            background: var(--background-gradient);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-icon {
            font-size: 32px;
            background: rgba(255,255,255,0.2);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-text h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .header-text p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .mode-switch {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #666;
            font-weight: 600;
            font-size: 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: var(--button-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }
        
        .form-label.required::after {
            content: ' *';
            color: #ff4444;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--button-primary);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .select-wrapper {
            position: relative;
        }
        
        .select-wrapper::after {
            content: '‚ñº';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
        
        select.form-input {
            appearance: none;
            padding-right: 40px;
            background: white;
        }
        
        .driver-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            background: white;
            cursor: pointer;
        }
        
        .driver-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .info-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .status-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .status-btn {
            padding: 14px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            color: #333;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .status-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .btn-online.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .btn-busy.active {
            background: #FF9800;
            color: white;
            border-color: #FF9800;
        }
        
        .btn-offline.active {
            background: #F44336;
            color: white;
            border-color: #F44336;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--button-primary);
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            background: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background: #e0e0e0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
            max-width: 90%;
        }
        
        .notification.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .notification.success {
            background: #4CAF50;
        }
        
        .notification.error {
            background: #F44336;
        }
        
        .connection-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            z-index: 100;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #F44336;
        }
        
        .status-dot.connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .vk-user {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        
        .vk-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .vk-user-info {
            color: white;
        }
        
        .vk-user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .vk-user-id {
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="vk-app" id="vkApp">
        <div class="app-header">
            <div class="header-content">
                <div class="header-icon">üöó</div>
                <div class="header-text">
                    <h1>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è</h1>
                    <p>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º</p>
                </div>
            </div>
            <div id="vkUserInfo" class="vk-user" style="display: none;">
                <div class="vk-user-avatar" id="userAvatar">V</div>
                <div class="vk-user-info">
                    <div class="vk-user-name" id="userName"></div>
                    <div class="vk-user-id" id="userId"></div>
                </div>
            </div>
        </div>
        
        <div class="mode-switch">
            <button class="mode-btn active" id="btnControl">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            <button class="mode-btn" id="btnRegister">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <div id="notification" class="notification"></div>
        
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="panel active" id="controlPanel">
            <div class="card">
                <div class="card-title">üë§ –í—ã–±–æ—Ä –≤–æ–¥–∏—Ç–µ–ª—è</div>
                <select class="driver-select" id="driverSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                </select>
            </div>
            
            <div class="card">
                <div class="card-title">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div class="driver-info-grid">
                    <div class="info-item">
                        <div class="info-label">–í–æ–¥–∏—Ç–µ–ª—å</div>
                        <div class="info-value" id="driverName">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                        <div class="info-value" id="driverPhone">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                        <div class="info-value" id="carModel">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–ì–æ—Å. –Ω–æ–º–µ—Ä</div>
                        <div class="info-value" id="carNumber">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–°—Ç–∞—Ç—É—Å</div>
                        <div class="info-value" id="currentStatus">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                        <div class="info-value" id="lastLocation">-</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üîÑ –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</div>
                <div class="status-buttons">
                    <button class="status-btn btn-online" onclick="updateStatus('online')">
                        <span>üü¢</span>
                        –°–≤–æ–±–æ–¥–µ–Ω
                    </button>
                    <button class="status-btn btn-busy" onclick="updateStatus('busy')">
                        <span>üü°</span>
                        –ù–∞ –∑–∞–∫–∞–∑–µ
                    </button>
                    <button class="status-btn btn-offline" onclick="updateStatus('offline')">
                        <span>üî¥</span>
                        –ù–µ –Ω–∞ –ª–∏–Ω–∏–∏
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üìç –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</div>
                <input type="text" 
                       class="form-input" 
                       id="locationInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å">
                <button class="btn btn-primary" onclick="updateLocation()" style="margin-top: 15px;">
                    –û–±–Ω–æ–≤–∏—Ç—å –∞–¥—Ä–µ—Å
                </button>
                <div style="font-size: 12px; color: #666; margin-top: 10px;" id="lastUpdateTime">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: -
                </div>
            </div>
        </div>
        
        <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="panel" id="registrationPanel">
            <div class="card">
                <div class="card-title">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è</div>
                
                <div class="form-group">
                    <label class="form-label required">–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è</label>
                    <input type="text" class="form-input" id="regName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-input" id="regPhone" placeholder="+79161234567">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                        <input type="text" class="form-input" id="regCarNumber" placeholder="–ê123–í–°777">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ</label>
                        <input type="text" class="form-input" id="regCarModel" placeholder="Toyota Camry">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">–°—Ç–∞—Ç—É—Å</label>
                        <div class="select-wrapper">
                            <select class="form-input" id="regStatus">
                                <option value="online">üü¢ –°–≤–æ–±–æ–¥–µ–Ω</option>
                                <option value="busy">üü° –ù–∞ –∑–∞–∫–∞–∑–µ</option>
                                <option value="offline">üî¥ –ù–µ –Ω–∞ –ª–∏–Ω–∏–∏</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å</label>
                    <input type="text" class="form-input" id="regAddress" placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, –¥. 25">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="regLocation" 
                           placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –¥–æ–º–∞—à–Ω–∏–º">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="switchPanel('control')">
                        –ù–∞–∑–∞–¥
                    </button>
                    <button class="btn btn-primary" onclick="registerDriver()">
                        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
        
        <div class="connection-status" id="connectionStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
        </div>
    </div>
    
    <!-- VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <script src="/vk-bridge.js"></script>
    
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SERVER_URL = window.location.origin.replace(/^http/, 'ws');
        let socket;
        let currentDriver = null;
        let allDrivers = [];
        let vkUser = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK
        async function initVK() {
            try {
                vkUser = await VKAPI.getUserData();
                if (vkUser) {
                    showVKUserInfo(vkUser);
                }
            } catch (error) {
                console.log('VK –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            }
        }
        
        function showVKUserInfo(user) {
            const userInfo = document.getElementById('vkUserInfo');
            const userName = document.getElementById('userName');
            const userId = document.getElementById('userId');
            const userAvatar = document.getElementById('userAvatar');
            
            userInfo.style.display = 'flex';
            userName.textContent = `${user.first_name} ${user.last_name}`;
            userId.textContent = `ID: ${user.id}`;
            userAvatar.textContent = user.first_name[0] + user.last_name[0];
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            socket = io(SERVER_URL);
            
            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                updateConnectionStatus(true);
                loadDrivers();
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            });
            
            socket.on('disconnect', () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                updateConnectionStatus(false);
                showNotification('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            });
            
            socket.on('initial_data', (drivers) => {
                allDrivers = drivers;
                updateDriverSelect(drivers);
            });
            
            socket.on('driver_status_updated', (driver) => {
                if (currentDriver && driver.id === currentDriver.id) {
                    updateDriverInfo(driver);
                    showNotification(`–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${getStatusText(driver.status)}`, 'success');
                }
                loadDrivers();
            });
            
            socket.on('driver_added', (driver) => {
                showNotification(`–ù–æ–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å ${driver.name} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!`, 'success');
                loadDrivers();
                switchPanel('control');
                // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è
                setTimeout(() => {
                    document.getElementById('driverSelect').value = driver.id;
                    document.getElementById('driverSelect').dispatchEvent(new Event('change'));
                }, 500);
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
        function switchPanel(panelName) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            
            if (panelName === 'control') {
                document.getElementById('controlPanel').classList.add('active');
                document.getElementById('btnControl').classList.add('active');
            } else {
                document.getElementById('registrationPanel').classList.add('active');
                document.getElementById('btnRegister').classList.add('active');
            }
        }
        
        document.getElementById('btnControl').addEventListener('click', () => switchPanel('control'));
        document.getElementById('btnRegister').addEventListener('click', () => switchPanel('register'));
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
        async function loadDrivers() {
            try {
                const response = await fetch('/api/drivers');
                allDrivers = await response.json();
                updateDriverSelect(allDrivers);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π', 'error');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        function updateDriverSelect(drivers) {
            const select = document.getElementById('driverSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>';
            
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = `${driver.name} (${driver.carNumber})`;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // –í—ã–±–æ—Ä –≤–æ–¥–∏—Ç–µ–ª—è
        document.getElementById('driverSelect').addEventListener('change', function(e) {
            const driverId = e.target.value;
            if (!driverId) {
                currentDriver = null;
                resetDriverInfo();
                return;
            }
            
            const driver = allDrivers.find(d => d.id === driverId);
            if (driver) {
                currentDriver = driver;
                updateDriverInfo(driver);
                updateStatusButtons(driver.status);
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateDriverInfo(driver) {
            document.getElementById('driverName').textContent = driver.name;
            document.getElementById('driverPhone').textContent = driver.phone;
            document.getElementById('carModel').textContent = driver.carModel;
            document.getElementById('carNumber').textContent = driver.carNumber;
            document.getElementById('currentStatus').textContent = getStatusText(driver.status);
            document.getElementById('lastLocation').textContent = driver.lastLocation;
            
            const lastUpdate = new Date(driver.lastStatusChange);
            document.getElementById('lastUpdateTime').textContent = 
                `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${lastUpdate.toLocaleString('ru-RU')}`;
            
            updateStatusButtons(driver.status);
        }
        
        function resetDriverInfo() {
            document.getElementById('driverName').textContent = '-';
            document.getElementById('driverPhone').textContent = '-';
            document.getElementById('carModel').textContent = '-';
            document.getElementById('carNumber').textContent = '-';
            document.getElementById('currentStatus').textContent = '-';
            document.getElementById('lastLocation').textContent = '-';
            document.getElementById('lastUpdateTime').textContent = '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: -';
            
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        function updateStatusButtons(status) {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.btn-${status}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        async function updateStatus(newStatus) {
            if (!currentDriver) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è', 'error');
                return;
            }
            
            updateStatusButtons(newStatus);
            
            try {
                const response = await fetch(`/api/drivers/${currentDriver.id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: newStatus,
                        lastLocation: document.getElementById('locationInput').value || currentDriver.lastLocation
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentDriver = data.driver;
                    updateDriverInfo(data.driver);
                    showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${getStatusText(newStatus)}`, 'success');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        async function updateLocation() {
            if (!currentDriver) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è', 'error');
                return;
            }
            
            const newLocation = document.getElementById('locationInput').value.trim();
            if (!newLocation) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/drivers/${currentDriver.id}/location`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lastLocation: newLocation })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentDriver.lastLocation = newLocation;
                    updateDriverInfo(currentDriver);
                    document.getElementById('locationInput').value = '';
                    showNotification('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è', 'error');
            }
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–¥–∏—Ç–µ–ª—è
        async function registerDriver() {
            const driverData = {
                name: document.getElementById('regName').value.trim(),
                phone: document.getElementById('regPhone').value.trim(),
                carNumber: document.getElementById('regCarNumber').value.trim().toUpperCase(),
                carModel: document.getElementById('regCarModel').value.trim(),
                status: document.getElementById('regStatus').value,
                address: document.getElementById('regAddress').value.trim(),
                lastLocation: document.getElementById('regLocation').value.trim() || 
                              document.getElementById('regAddress').value.trim()
            };
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const errors = [];
            if (!driverData.name) errors.push('–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è');
            if (!driverData.phone) errors.push('–¢–µ–ª–µ—Ñ–æ–Ω');
            if (!driverData.carNumber) errors.push('–ì–æ—Å. –Ω–æ–º–µ—Ä');
            if (!driverData.carModel) errors.push('–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ');
            if (!driverData.address) errors.push('–î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å');
            
            if (errors.length > 0) {
                showNotification(`–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: ${errors.join(', ')}`, 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/drivers/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(driverData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    ['regName', 'regPhone', 'regCarNumber', 'regCarModel', 'regAddress', 'regLocation']
                        .forEach(id => document.getElementById(id).value = '');
                    
                    showNotification(`–í–æ–¥–∏—Ç–µ–ª—å ${driverData.name} —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!`, 'success');
                } else {
                    showNotification(result.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getStatusText(status) {
            const statusMap = {
                online: 'üü¢ –°–≤–æ–±–æ–¥–µ–Ω',
                busy: 'üü° –ù–∞ –∑–∞–∫–∞–∑–µ',
                offline: 'üî¥ –ù–µ –Ω–∞ –ª–∏–Ω–∏–∏'
            };
            return statusMap[status] || status;
        }
        
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = '–í —Å–µ—Ç–∏';
            } else {
                dot.className = 'status-dot';
                text.textContent = '–ù–µ—Ç —Å–≤—è–∑–∏';
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await initVK();
            connectWebSocket();
        });
    </script>
</body>
</html>